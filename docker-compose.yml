services:
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    image: night-worker:local
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp:size=512m,mode=1777
      - /job:size=100m,mode=1777
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    working_dir: /runner
    environment:
      - HOME=/home/worker
    volumes:
      - claude_home:/home/worker
      - ${CLAUDE_CREDS_VOLUME:-/dev/null:/dev/null}
    entrypoint: ["/usr/local/bin/entrypoint.sh"]

  test:
    build:
      context: .
      dockerfile: tests/Dockerfile
    volumes:
      - .:/app:ro
    command: ["python", "-m", "pytest", "tests/", "-v"]
    profiles:
      - test

volumes:
  claude_home:
